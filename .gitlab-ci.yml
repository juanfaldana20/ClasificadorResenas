stages:
  - test
  - build
  - deploy

# -------------------------------
# Stage 1: Tests
# -------------------------------
backend-tests:
  stage: test
  image: python:3.10-slim
  script:
    - apt-get update && apt-get install -y build-essential git curl
    - pip install uv
    - echo "ğŸ“‚ Contenido del repo clonado:"
    - ls -R $CI_PROJECT_DIR
    - test -f $CI_PROJECT_DIR/backend/pyproject.toml || (echo "âŒ backend pyproject.toml no encontrado" && exit 1)
    - cd $CI_PROJECT_DIR/backend
    - uv pip compile pyproject.toml -o requirements.txt
    - uv pip install --system -r requirements.txt --no-cache-dir
    - pip install pytest
    - echo "â–¶ï¸ Ejecutando tests de backend"
    - pytest ML/codigos_test.py -v

# -------------------------------
# Stage 2: Build + Push Backend
# -------------------------------
build-backend:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  variables:
    DOCKER_DRIVER: overlay2
  script:
    - echo "ğŸ”‘ Iniciando sesiÃ³n en Azure ACR"
    - echo $AZURE_ACR_PASSWORD | docker login aplicacionstreamlit.azurecr.io -u $AZURE_ACR_USERNAME --password-stdin
    - echo "ğŸ³ Construyendo imagen backend..."
    - docker build -t aplicacionstreamlit.azurecr.io/reviews-backend:latest ./backend
    - echo "â¬†ï¸ Pusheando imagen backend al ACR..."
    - docker push aplicacionstreamlit.azurecr.io/reviews-backend:latest
  only:
    - main

# -------------------------------
# Stage 3: Build + Push + Deploy Frontend
# -------------------------------
build-deploy-frontend:
  stage: deploy
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  variables:
    DOCKER_DRIVER: overlay2
  script:
    - echo "ğŸ”‘ Iniciando sesiÃ³n en Azure ACR"
    - echo $AZURE_ACR_PASSWORD | docker login aplicacionstreamlit.azurecr.io -u $AZURE_ACR_USERNAME --password-stdin
    - echo "ğŸ³ Construyendo imagen frontend..."
    - docker build -t aplicacionstreamlit.azurecr.io/frontend:latest ./frontend
    - echo "â¬†ï¸ Pusheando imagen frontend al ACR..."
    - docker push aplicacionstreamlit.azurecr.io/frontend:latest
    - echo "ğŸš€ Desplegando nueva imagen frontend en Azure Container Apps"
    - az containerapp update --name frontend-app --resource-group $AZ_RESOURCE_GROUP --image aplicacionstreamlit.azurecr.io/frontend:latest
  only:
    - main
