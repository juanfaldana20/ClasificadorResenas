stages:
  - test

run_tests:
  stage: test
  image: python:3.10-slim   # Igual que tu Dockerfile
  before_script:
    - apt-get update && apt-get install -y --no-install-recommends build-essential git curl
    - pip install uv
  script:
    # Verificar que el archivo existe
    - test -f backend/ML/pyproject.toml || (echo "❌ pyproject.toml no encontrado" && exit 1)
    
    # Mostrar estructura (debug)
    - pwd
    - ls -R backend/ML
    
    # Instalar dependencias con uv
    - cd backend/ML
    - uv pip compile pyproject.toml -o requirements.txt
    - uv pip install --system -r requirements.txt --no-cache-dir
    
    # Instalar torch CPU (como en tu Dockerfile)
    - pip install --no-cache-dir torch==2.6.0 --index-url https://download.pytorch.org/whl/cpu
    
    # Instalar pytest si no está en pyproject.toml
    - pip install pytest
    
    # Ejecutar tests
    - pytest codigos_test.py
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "develop"'

